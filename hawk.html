<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hawk - ä¸¦åˆ—é‡å­ãƒ“ãƒƒãƒˆè¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0a1a; min-height: 100vh; font-family: monospace; color: #fff; padding: 15px; }
        h1 { text-align: center; color: #00d4ff; margin-bottom: 5px; font-size: 1.8rem; }
        .subtitle { text-align: center; color: #888; font-size: 0.8rem; margin-bottom: 15px; }
        .main-container { display: grid; grid-template-columns: 120px 300px 280px 280px; gap: 8px; max-width: 1100px; margin: 0 auto; }
        .panel { background: rgba(0,0,0,0.5); border: 2px solid #00d4ff; border-radius: 10px; padding: 8px; min-width: 0; }
        .sidebar { }
        .editor-area { }
        .qubits-area { }
        .output-area { }
        h3 { color: #00d4ff; margin-bottom: 8px; font-size: 0.85rem; }
        .btn { display: block; width: 100%; padding: 6px; margin-bottom: 4px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.75rem; color: #fff; background: #333; }
        .btn:hover { background: #444; }
        .btn-run { background: #10b981; font-size: 0.85rem; padding: 8px; }
        .btn-run:hover { background: #059669; }
        textarea { width: 100%; height: 320px; background: #111; border: 1px solid #333; border-radius: 5px; padding: 8px; color: #fff; font-family: monospace; font-size: 11px; resize: none; }
        textarea:focus { outline: none; border-color: #00d4ff; }
        #output { background: #111; border: 1px solid #333; border-radius: 5px; padding: 8px; height: 320px; overflow-y: auto; font-size: 10px; }
        .out-print { color: #10b981; margin-bottom: 2px; }
        .out-error { color: #ec4899; margin-bottom: 2px; }
        .out-quantum { color: #06b6d4; font-size: 0.8em; margin-bottom: 2px; }
        .out-info { color: #888; margin-bottom: 2px; }
        .toolbar { margin-bottom: 8px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        label { font-size: 0.7rem; color: #888; display: flex; align-items: center; gap: 4px; }
        
        /* é‡å­ãƒ“ãƒƒãƒˆè¡¨ç¤º */
        .qubits-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .qubit-cell {
            background: rgba(0,0,0,0.7);
            border: 2px solid #333;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            transition: all 0.1s;
        }
        .qubit-cell.state-0 { border-color: #10b981; background: rgba(16,185,129,0.1); }
        .qubit-cell.state-1 { border-color: #ec4899; background: rgba(236,72,153,0.1); }
        .qubit-cell.state-super { border-color: #f59e0b; background: rgba(245,158,11,0.1); animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        .qubit-id { font-size: 0.6rem; color: #666; }
        .qubit-value { font-size: 1.2rem; font-weight: bold; margin: 4px 0; }
        .qubit-r { font-size: 0.6rem; color: #888; }
        .qubit-prob { font-size: 0.55rem; color: #06b6d4; }
        
        .stats { font-size: 0.65rem; color: #888; margin-top: 8px; }
        .stats div { margin: 2px 0; display: flex; justify-content: space-between; }
        .stats span { color: #00d4ff; }
        
        .controls { margin-bottom: 10px; }
        .controls input[type="range"] { width: 100%; }
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.7rem; }
    </style>
</head>
<body>
    <h1>ğŸ¦… Hawk</h1>
    <p class="subtitle">ä¸¦åˆ—é‡å­ãƒ“ãƒƒãƒˆè¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ - è¤‡æ•°ã®é‡å­ãƒ“ãƒƒãƒˆãŒåŒæ™‚ã«å‹•ä½œ</p>
    
    <div class="main-container">
        <div class="panel sidebar">
            <h3>ã‚µãƒ³ãƒ—ãƒ«</h3>
            <button class="btn" onclick="loadExample('hello')">Hello World</button>
            <button class="btn" onclick="loadExample('calc')">é‡å­è¨ˆç®—</button>
            <button class="btn" onclick="loadExample('parallel')">ä¸¦åˆ—è¨ˆç®—</button>
            <button class="btn" onclick="loadExample('vote')">å¤šæ•°æ±º</button>
            <button class="btn" onclick="loadExample('search')">é‡å­æ¢ç´¢</button>
            <button class="btn" onclick="loadExample('fib')">ãƒ•ã‚£ãƒœãƒŠãƒƒãƒ</button>
            
            <div class="stats" style="margin-top: 15px;">
                <div style="color:#06b6d4;margin-bottom:5px">âš›ï¸ çµ±è¨ˆ</div>
                <div>ç·æ¼”ç®—: <span id="calcCount">0</span></div>
                <div>æ¸¬å®šå›æ•°: <span id="measureCount">0</span></div>
                <div>ä¸¦åˆ—åº¦: <span id="parallelism">0</span></div>
            </div>
        </div>
        
        <div class="panel editor-area">
            <div class="toolbar">
                <button class="btn btn-run" onclick="runCode()">â–¶ å®Ÿè¡Œ</button>
                <label><input type="checkbox" id="showQuantum" checked> ãƒ­ã‚°</label>
                <label><input type="checkbox" id="autoRun"> è‡ªå‹•æ›´æ–°</label>
            </div>
            <textarea id="editor"># ä¸¦åˆ—é‡å­ãƒ“ãƒƒãƒˆè¨ˆç®—ãƒ‡ãƒ¢
# 16å€‹ã®é‡å­ãƒ“ãƒƒãƒˆãŒåŒæ™‚ã«å‹•ä½œï¼

print("=== ä¸¦åˆ—é‡å­è¨ˆç®— ===")

# é‡å­ãƒ“ãƒƒãƒˆã‚’ä½œæˆï¼ˆç›¸é–¢ä¿‚æ•°0.5ï¼‰
q = qubits(16, 0.5)
print("é‡å­ãƒ“ãƒƒãƒˆæ•°:", len(q))

# å…¨é‡å­ãƒ“ãƒƒãƒˆã‚’æ¸¬å®š
results = measure_all(q)
print("æ¸¬å®šçµæœ:", results)

# 0ã¨1ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
zeros = count(results, 0)
ones = count(results, 1)
print("0ã®æ•°:", zeros)
print("1ã®æ•°:", ones)</textarea>
        </div>
        
        <div class="panel qubits-area">
            <h3>é‡å­ãƒ“ãƒƒãƒˆçŠ¶æ…‹ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ )</h3>
            <div class="controls">
                <div class="control-row">
                    <span>é‡å­ãƒ“ãƒƒãƒˆæ•°:</span>
                    <span id="numQubitsValue">16</span>
                </div>
                <input type="range" id="numQubits" min="4" max="64" value="16" oninput="updateQubitDisplay()">
                <div class="control-row">
                    <span>ç›¸é–¢ä¿‚æ•° r:</span>
                    <span id="rValue">0.00</span>
                </div>
                <input type="range" id="rSlider" min="-100" max="100" value="0" oninput="updateQubitDisplay()">
                <div class="control-row">
                    <span>æ›´æ–°é€Ÿåº¦:</span>
                    <span id="speedValue">100ms</span>
                </div>
                <input type="range" id="speedSlider" min="50" max="1000" value="100" oninput="updateSpeed()">
            </div>
            <div id="qubitsGrid" class="qubits-grid"></div>
            <div class="stats">
                <div>P(0): <span id="prob0">50.0%</span></div>
                <div>P(1): <span id="prob1">50.0%</span></div>
                <div>å®Ÿæ¸¬0: <span id="actual0">0</span></div>
                <div>å®Ÿæ¸¬1: <span id="actual1">0</span></div>
            </div>
        </div>
        
        <div class="panel output-area">
            <h3>å‡ºåŠ›</h3>
            <div id="output"></div>
        </div>
    </div>

<script>
(function(){
    // ========================================
    // ä¸¦åˆ—é‡å­ãƒ“ãƒƒãƒˆè¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³
    // ========================================
    
    var stats = { calcCount: 0, measureCount: 0, parallelism: 0 };
    var quantumLogs = [];
    var outputLines = [];
    var globalVars = {};
    var globalFuncs = {};
    var activeQubits = [];  // ç¾åœ¨ã®é‡å­ãƒ“ãƒƒãƒˆé…åˆ—
    var animationTimer = null;
    var updateInterval = 100;
    
    // ========================================
    // æ“¬ä¼¼é‡å­ãƒ“ãƒƒãƒˆã‚¯ãƒ©ã‚¹
    // ========================================
    function Qubit(r) {
        this.r = Math.max(-1, Math.min(1, r || 0));  // ç›¸é–¢ä¿‚æ•° [-1, 1]
        this.theta = Math.PI * (1 - this.r) / 2;
        this.alpha = Math.cos(this.theta / 2);  // |0âŸ©æŒ¯å¹…
        this.beta = Math.sin(this.theta / 2);   // |1âŸ©æŒ¯å¹…
        this.lastMeasurement = null;  // æœ€å¾Œã®æ¸¬å®šçµæœ
        this.measureCount = 0;
    }
    
    Qubit.prototype.p0 = function() { return this.alpha * this.alpha; };
    Qubit.prototype.p1 = function() { return this.beta * this.beta; };
    
    // é‡å­æ¸¬å®šï¼ˆç¢ºç‡çš„ã«0ã‹1ã‚’è¿”ã™ï¼‰
    Qubit.prototype.measure = function() {
        stats.measureCount++;
        this.measureCount++;
        var result = Math.random() < this.p0() ? 0 : 1;
        this.lastMeasurement = result;
        return result;
    };
    
    // è¤‡æ•°å›æ¸¬å®šã—ã¦çµ±è¨ˆã‚’å–ã‚‹
    Qubit.prototype.sample = function(n) {
        var zeros = 0;
        for (var i = 0; i < n; i++) {
            if (Math.random() < this.p0()) zeros++;
        }
        return { zeros: zeros, ones: n - zeros, ratio: zeros / n };
    };
    
    // ========================================
    // é‡å­ãƒ“ãƒƒãƒˆé…åˆ—æ“ä½œ
    // ========================================
    
    // nå€‹ã®é‡å­ãƒ“ãƒƒãƒˆã‚’ä½œæˆ
    function createQubits(n, r) {
        r = r !== undefined ? r : 0;
        var qubits = [];
        for (var i = 0; i < n; i++) {
            qubits.push(new Qubit(r));
        }
        stats.parallelism = Math.max(stats.parallelism, n);
        qLog("âš›ï¸ " + n + "å€‹ã®é‡å­ãƒ“ãƒƒãƒˆä½œæˆ (r=" + r.toFixed(2) + ")");
        return qubits;
    }
    
    // å…¨é‡å­ãƒ“ãƒƒãƒˆã‚’æ¸¬å®š
    function measureAll(qubits) {
        var results = [];
        for (var i = 0; i < qubits.length; i++) {
            results.push(qubits[i].measure());
        }
        qLog("ğŸ“Š " + qubits.length + "å€‹ã‚’æ¸¬å®š: [" + results.join("") + "]");
        return results;
    }
    
    // çµæœã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    function countResults(results, value) {
        var count = 0;
        for (var i = 0; i < results.length; i++) {
            if (results[i] === value) count++;
        }
        return count;
    }
    
    // å¤šæ•°æ±º
    function majorityVote(results) {
        var zeros = countResults(results, 0);
        var ones = results.length - zeros;
        return zeros > ones ? 0 : (ones > zeros ? 1 : (Math.random() < 0.5 ? 0 : 1));
    }
    
    // é‡å­ä¸¦åˆ—è¨ˆç®—ï¼ˆå…¨é‡å­ãƒ“ãƒƒãƒˆã§åŒæ™‚ã«è¨ˆç®—ï¼‰
    function quantumParallel(qubits, func) {
        stats.calcCount++;
        var results = [];
        for (var i = 0; i < qubits.length; i++) {
            var m = qubits[i].measure();
            results.push(func(m, i));
        }
        return results;
    }
    
    // ========================================
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
    // ========================================
    function updateQubitDisplay() {
        var n = parseInt(document.getElementById('numQubits').value);
        var r = parseInt(document.getElementById('rSlider').value) / 100;
        
        document.getElementById('numQubitsValue').textContent = n;
        document.getElementById('rValue').textContent = r.toFixed(2);
        
        // é‡å­ãƒ“ãƒƒãƒˆé…åˆ—ã‚’æ›´æ–°
        activeQubits = [];
        for (var i = 0; i < n; i++) {
            activeQubits.push(new Qubit(r));
        }
        
        // ç¢ºç‡è¡¨ç¤º
        var p0 = (1 + r) / 2;
        document.getElementById('prob0').textContent = (p0 * 100).toFixed(1) + '%';
        document.getElementById('prob1').textContent = ((1 - p0) * 100).toFixed(1) + '%';
        
        renderQubits();
    }
    
    function renderQubits() {
        var grid = document.getElementById('qubitsGrid');
        var cols = activeQubits.length <= 16 ? 4 : (activeQubits.length <= 36 ? 6 : 8);
        grid.style.gridTemplateColumns = 'repeat(' + cols + ', 1fr)';
        
        var html = '';
        var zeros = 0, ones = 0;
        
        for (var i = 0; i < activeQubits.length; i++) {
            var q = activeQubits[i];
            var m = q.measure();  // æ¸¬å®š
            if (m === 0) zeros++; else ones++;
            
            var stateClass = m === 0 ? 'state-0' : 'state-1';
            var color = m === 0 ? '#10b981' : '#ec4899';
            
            html += '<div class="qubit-cell ' + stateClass + '">';
            html += '<div class="qubit-id">Q' + i + '</div>';
            html += '<div class="qubit-value" style="color:' + color + '">' + m + '</div>';
            html += '<div class="qubit-r">r=' + q.r.toFixed(2) + '</div>';
            html += '<div class="qubit-prob">Pâ‚€=' + (q.p0() * 100).toFixed(0) + '%</div>';
            html += '</div>';
        }
        
        grid.innerHTML = html;
        document.getElementById('actual0').textContent = zeros;
        document.getElementById('actual1').textContent = ones;
    }
    
    function startAnimation() {
        if (animationTimer) return;
        animationTimer = setInterval(renderQubits, updateInterval);
    }
    
    function stopAnimation() {
        if (animationTimer) {
            clearInterval(animationTimer);
            animationTimer = null;
        }
    }
    
    function updateSpeed() {
        updateInterval = parseInt(document.getElementById('speedSlider').value);
        document.getElementById('speedValue').textContent = updateInterval + 'ms';
        if (animationTimer) {
            stopAnimation();
            startAnimation();
        }
    }
    
    // ========================================
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿
    // ========================================
    function qLog(s) { quantumLogs.push(s); }
    function output(s) { outputLines.push({text: String(s), type: 'print'}); }
    function outputErr(s) { outputLines.push({text: s, type: 'error'}); }
    
    function evalExpr(e) {
        e = e.trim();
        if (!e) return undefined;
        
        // æ–‡å­—åˆ—
        if ((e[0] === '"' && e[e.length-1] === '"') || (e[0] === "'" && e[e.length-1] === "'")) {
            return e.slice(1, -1);
        }
        // æ•°å€¤
        if (/^-?\d+\.?\d*$/.test(e)) return parseFloat(e);
        if (e === 'True') return true;
        if (e === 'False') return false;
        
        // æ‹¬å¼§ã§å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
        if (e[0] === '(' && e[e.length-1] === ')') {
            var lv = 0, valid = true;
            for (var i = 0; i < e.length - 1; i++) {
                if (e[i] === '(') lv++;
                if (e[i] === ')') lv--;
                if (lv === 0) { valid = false; break; }
            }
            if (valid) return evalExpr(e.slice(1, -1));
        }
        
        // æ¯”è¼ƒæ¼”ç®—å­ï¼ˆæ‹¬å¼§ã‚’è€ƒæ…®ï¼‰
        var ops = ['>=', '<=', '==', '!=', '>', '<'];
        for (var oi = 0; oi < ops.length; oi++) {
            var op = ops[oi];
            var idx = findOpOutsideParens(e, op);
            if (idx > 0) {
                var a = evalExpr(e.substring(0, idx));
                var b = evalExpr(e.substring(idx + op.length));
                switch(op) {
                    case '>': return a > b;
                    case '<': return a < b;
                    case '>=': return a >= b;
                    case '<=': return a <= b;
                    case '==': return a === b;
                    case '!=': return a !== b;
                }
            }
        }
        
        // + - ï¼ˆæ‹¬å¼§ã‚’è€ƒæ…®ã€å³ã‹ã‚‰æ¢ã™ï¼‰
        var lv = 0;
        for (var i = e.length - 1; i >= 0; i--) {
            if (e[i] === ')' || e[i] === ']') lv++;
            if (e[i] === '(' || e[i] === '[') lv--;
            if (lv === 0) {
            if (e[i] === '+') return evalExpr(e.substring(0, i)) + evalExpr(e.substring(i + 1));
                if (e[i] === '-' && i > 0 && !/[*\/\(\,\[]/.test(e[i-1])) {
                    return evalExpr(e.substring(0, i)) - evalExpr(e.substring(i + 1));
                }
            }
        }
        
        // * / % ï¼ˆæ‹¬å¼§ã‚’è€ƒæ…®ï¼‰
        lv = 0;
        for (var i = e.length - 1; i >= 0; i--) {
            if (e[i] === ')' || e[i] === ']') lv++;
            if (e[i] === '(' || e[i] === '[') lv--;
            if (lv === 0) {
            if (e[i] === '*') return evalExpr(e.substring(0, i)) * evalExpr(e.substring(i + 1));
            if (e[i] === '/') return evalExpr(e.substring(0, i)) / evalExpr(e.substring(i + 1));
            if (e[i] === '%') return evalExpr(e.substring(0, i)) % evalExpr(e.substring(i + 1));
        }
        }
        
        // é–¢æ•°å‘¼ã³å‡ºã—
        var fm = e.match(/^(\w+)\((.*)?\)$/);
        if (fm) return callFunc(fm[1], fm[2] || '');
        
        // ãƒªã‚¹ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        var idxMatch = e.match(/^(\w+)\[(.+)\]$/);
        if (idxMatch) {
            var arr = globalVars[idxMatch[1]];
            var idx = evalExpr(idxMatch[2]);
            if (Array.isArray(arr)) return arr[idx];
            return undefined;
        }
        
        // å¤‰æ•°
        if (globalVars.hasOwnProperty(e)) return globalVars[e];
        return undefined;
    }
    
    // æ‹¬å¼§ã®å¤–ã§æ¼”ç®—å­ã‚’æ¢ã™
    function findOpOutsideParens(e, op) {
        var lv = 0;
        for (var i = 0; i < e.length - op.length + 1; i++) {
            if (e[i] === '(' || e[i] === '[') lv++;
            if (e[i] === ')' || e[i] === ']') lv--;
            if (lv === 0 && e.substring(i, i + op.length) === op) {
                return i;
            }
        }
        return -1;
    }
    
    function splitArgs(s) {
        var args = [], cur = '', lv = 0, inStr = false, strChar = '';
        for (var i = 0; i < s.length; i++) {
            var c = s[i];
            // å¼•ç”¨ç¬¦ã®è¿½è·¡
            if ((c === '"' || c === "'") && !inStr) {
                inStr = true; strChar = c;
            } else if (c === strChar && inStr) {
                inStr = false; strChar = '';
            }
            if (!inStr) {
                if (c === '(' || c === '[') lv++;
                if (c === ')' || c === ']') lv--;
                if (c === ',' && lv === 0) { args.push(cur.trim()); cur = ''; continue; }
            }
            cur += c;
        }
        if (cur.trim()) args.push(cur.trim());
        return args;
    }
    
    function callFunc(name, argStr) {
        var argStrs = splitArgs(argStr);
        var args = argStrs.map(function(a) { return evalExpr(a); });
        
        // æ¨™æº–é–¢æ•°
        if (name === 'print') {
            output(args.join(' '));
            return null;
        }
        if (name === 'range') {
            var r = [];
            var start = 0, end = args[0], step = 1;
            if (args.length >= 2) { start = args[0]; end = args[1]; }
            if (args.length >= 3) step = args[2];
            for (var i = start; step > 0 ? i < end : i > end; i += step) r.push(i);
            return r;
        }
        if (name === 'len') return Array.isArray(args[0]) ? args[0].length : 0;
        if (name === 'sum') {
            var s = 0;
            for (var i = 0; i < args[0].length; i++) s += args[0][i];
            return s;
        }
        
        // é‡å­ãƒ“ãƒƒãƒˆé–¢æ•°
        if (name === 'qubits') {
            // qubits(n, r) - nå€‹ã®é‡å­ãƒ“ãƒƒãƒˆã‚’ä½œæˆ
            var n = args[0] || 8;
            var r = args.length > 1 ? args[1] : 0;
            var qubits = createQubits(n, r);
            activeQubits = qubits;
            updateQubitDisplayFromCode(n, r);
            return qubits;
        }
        if (name === 'measure_all') {
            // measure_all(qubits) - å…¨é‡å­ãƒ“ãƒƒãƒˆã‚’æ¸¬å®š
            return measureAll(args[0]);
        }
        if (name === 'measure') {
            // measure(qubit) - å˜ä¸€é‡å­ãƒ“ãƒƒãƒˆã‚’æ¸¬å®š
            if (args[0] instanceof Qubit) return args[0].measure();
            if (Array.isArray(args[0])) return measureAll(args[0]);
            return args[0];
        }
        if (name === 'count') {
            // count(results, value) - å€¤ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            return countResults(args[0], args[1]);
        }
        if (name === 'vote') {
            // vote(results) - å¤šæ•°æ±º
            return majorityVote(args[0]);
        }
        if (name === 'parallel') {
            // parallel(qubits, expr) - ä¸¦åˆ—è¨ˆç®—
            var qubits = args[0];
            var results = [];
            for (var i = 0; i < qubits.length; i++) {
                globalVars['_m'] = qubits[i].measure();
                globalVars['_i'] = i;
                results.push(evalExpr(args[1]));
            }
            return results;
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°
        if (globalFuncs[name]) {
            var f = globalFuncs[name];
            var oldVars = Object.assign({}, globalVars);
            for (var pi = 0; pi < f.params.length; pi++) {
                globalVars[f.params[pi]] = args[pi];
            }
            var ret = runBlock(f.body);
            globalVars = oldVars;
            return ret ? ret.value : undefined;
        }
        
        return undefined;
    }
    
    function updateQubitDisplayFromCode(n, r) {
        document.getElementById('numQubits').value = n;
        document.getElementById('numQubitsValue').textContent = n;
        document.getElementById('rSlider').value = Math.round(r * 100);
        document.getElementById('rValue').textContent = r.toFixed(2);
        var p0 = (1 + r) / 2;
        document.getElementById('prob0').textContent = (p0 * 100).toFixed(1) + '%';
        document.getElementById('prob1').textContent = ((1 - p0) * 100).toFixed(1) + '%';
    }
    
    function runBlock(lines) {
        var i = 0;
        while (i < lines.length) {
            var raw = lines[i];
            var line = raw.trim();
            var indent = raw.search(/\S/);
            if (indent < 0) indent = 0;
            
            if (!line || line[0] === '#') { i++; continue; }
            
            try {
                // def
                if (line.indexOf('def ') === 0 && line.indexOf(':') > 0) {
                    var m = line.match(/def\s+(\w+)\((.*)\):/);
                    if (m) {
                        var fn = m[1];
                        var ps = m[2] ? m[2].split(',').map(function(p){return p.trim();}) : [];
                        var body = [];
                        i++;
                        while (i < lines.length) {
                            var ni = lines[i].search(/\S/);
                            if (ni >= 0 && ni <= indent && lines[i].trim()) break;
                            body.push(lines[i]);
                            i++;
                        }
                        globalFuncs[fn] = {params: ps, body: body};
                        continue;
                    }
                }
                
                // return
                if (line.indexOf('return') === 0) {
                    return {done: true, type: 'return', value: evalExpr(line.substring(6).trim())};
                }
                
                // for
                if (line.indexOf('for ') === 0 && line.indexOf(' in ') > 0) {
                    var m = line.match(/for\s+(\w+)\s+in\s+(.+):/);
                    if (m) {
                        var vn = m[1];
                        var iter = evalExpr(m[2]);
                        var body = [];
                        i++;
                        while (i < lines.length) {
                            var ni = lines[i].search(/\S/);
                            if (ni >= 0 && ni <= indent && lines[i].trim()) break;
                            body.push(lines[i]);
                            i++;
                        }
                        if (Array.isArray(iter)) {
                            for (var ii = 0; ii < iter.length; ii++) {
                                globalVars[vn] = iter[ii];
                                var result = runBlock(body);
                                if (result && result.done) {
                                    if (result.type === 'return') return result;
                                    if (result.type === 'break') break;
                                }
                            }
                        }
                        continue;
                    }
                }
                
                // while
                if (line.indexOf('while ') === 0) {
                    var cond = line.slice(6, -1);
                    var body = [];
                    i++;
                    while (i < lines.length) {
                        var ni = lines[i].search(/\S/);
                        if (ni >= 0 && ni <= indent && lines[i].trim()) break;
                        body.push(lines[i]);
                        i++;
                    }
                    var cnt = 0;
                    while (evalExpr(cond) && cnt < 10000) {
                        var result = runBlock(body);
                        if (result && result.done) {
                            if (result.type === 'return') return result;
                            if (result.type === 'break') break;
                        }
                        cnt++;
                    }
                    continue;
                }
                
                // if
                if (line.indexOf('if ') === 0 && line.indexOf(':') > 0) {
                    var cond = evalExpr(line.slice(3, -1));
                    var ifBody = [];
                    i++;
                    while (i < lines.length) {
                        var ni = lines[i].search(/\S/);
                        if (ni >= 0 && ni <= indent && lines[i].trim()) break;
                        ifBody.push(lines[i]);
                        i++;
                    }
                    if (cond) {
                        var result = runBlock(ifBody);
                        if (result && result.done) return result;
                    }
                    continue;
                }
                
                // ä»£å…¥ï¼ˆå¼•ç”¨ç¬¦ã®å¤–ã®=ã®ã¿ï¼‰
                var eq = -1;
                var inStr = false, strCh = '';
                for (var ci = 0; ci < line.length; ci++) {
                    var c = line[ci];
                    if ((c === '"' || c === "'") && !inStr) {
                        inStr = true; strCh = c;
                    } else if (c === strCh && inStr) {
                        inStr = false; strCh = '';
                    }
                    if (!inStr && c === '=' && ci > 0) {
                        var prev = line[ci-1];
                        var next = line[ci+1] || '';
                        if (prev !== '!' && prev !== '<' && prev !== '>' && next !== '=') {
                            eq = ci;
                            break;
                        }
                    }
                }
                if (eq > 0) {
                    var left = line.substring(0, eq).trim();
                    var right = line.substring(eq + 1).trim();
                    // å·¦è¾ºãŒè­˜åˆ¥å­ã®å ´åˆã®ã¿ä»£å…¥
                    if (/^\w+$/.test(left)) {
                    globalVars[left] = evalExpr(right);
                    } else {
                        evalExpr(line);
                    }
                } else {
                    evalExpr(line);
                }
            } catch (err) {
                outputErr("ã‚¨ãƒ©ãƒ¼: " + err.message);
            }
            i++;
        }
        return {done: false};
    }
    
    window.runCode = function() {
        stats = { calcCount: 0, measureCount: 0, parallelism: 0 };
        quantumLogs = []; outputLines = []; globalVars = {}; globalFuncs = {};
        
        var code = document.getElementById('editor').value;
        var lines = code.split('\n');
        
        var startTime = performance.now();
        try {
        runBlock(lines);
        } catch (e) {
            outputErr("ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
        var endTime = performance.now();
        
        // é‡å­ãƒ“ãƒƒãƒˆè¡¨ç¤ºã‚’æ›´æ–°
        renderQubits();
        
        var html = '';
        for (var i = 0; i < outputLines.length; i++) {
            html += '<div class="out-' + outputLines[i].type + '">' + outputLines[i].text + '</div>';
        }
        html += '<div class="out-info">å®Ÿè¡Œæ™‚é–“: ' + (endTime - startTime).toFixed(2) + 'ms</div>';
        
        if (document.getElementById('showQuantum').checked && quantumLogs.length > 0) {
            html += '<div class="out-info">--- é‡å­ãƒ­ã‚° ---</div>';
            for (var i = 0; i < Math.min(quantumLogs.length, 30); i++) {
                html += '<div class="out-quantum">' + quantumLogs[i] + '</div>';
            }
        }
        
        document.getElementById('output').innerHTML = html;
        document.getElementById('calcCount').textContent = stats.calcCount;
        document.getElementById('measureCount').textContent = stats.measureCount;
        document.getElementById('parallelism').textContent = stats.parallelism;
    };
    
    window.loadExample = function(name) {
        var ex = {
            hello: '# Hello World\nprint("Hello Hawk!")\nprint("ä¸¦åˆ—é‡å­ãƒ“ãƒƒãƒˆè¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³")',
            calc: '# é‡å­è¨ˆç®—ãƒ‡ãƒ¢\n# é‡å­ãƒ“ãƒƒãƒˆã®ç¢ºç‡çš„ãªæŒ¯ã‚‹èˆã„\n\nq = qubits(8, 0.3)\nprint("8å€‹ã®é‡å­ãƒ“ãƒƒãƒˆ (r=0.3)")\n\nresults = measure_all(q)\nprint("æ¸¬å®šçµæœ:", results)\n\nprint("0ã®æ•°:", count(results, 0))\nprint("1ã®æ•°:", count(results, 1))',
            parallel: '# ä¸¦åˆ—é‡å­è¨ˆç®—\n# å…¨é‡å­ãƒ“ãƒƒãƒˆã§åŒæ™‚ã«è¨ˆç®—\n\nprint("=== ä¸¦åˆ—é‡å­è¨ˆç®— ===")\n\n# 32å€‹ã®é‡å­ãƒ“ãƒƒãƒˆ\nq = qubits(32, 0)\nprint("32å€‹ã®é‡å­ãƒ“ãƒƒãƒˆä½œæˆ")\n\n# å…¨ã¦ã‚’æ¸¬å®š\nresults = measure_all(q)\n\n# çµ±è¨ˆ\nzeros = count(results, 0)\nones = count(results, 1)\n\nprint("0:", zeros, "å€‹")\nprint("1:", ones, "å€‹")\nprint("æ¯”ç‡:", zeros / 32)',
            vote: '# å¤šæ•°æ±ºã«ã‚ˆã‚‹æ±ºå®š\n# é‡å­ãƒ“ãƒƒãƒˆã®å¤šæ•°æ±ºã§0ã‹1ã‚’æ±ºå®š\n\nprint("=== é‡å­å¤šæ•°æ±º ===")\n\n# ç›¸é–¢ä¿‚æ•°ã‚’å¤‰ãˆã¦å®Ÿé¨“\nfor r in range(-10, 11, 5):\n    r_val = r / 10\n    q = qubits(16, r_val)\n    results = measure_all(q)\n    winner = vote(results)\n    print("r=", r_val, "â†’ å‹è€…:", winner)',
            search: '# é‡å­æ¢ç´¢ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³\n\nprint("=== é‡å­æ¢ç´¢ ===")\n\n# ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«è¿‘ã„ç›¸é–¢ä¿‚æ•°ã‚’è¨­å®š\ntarget = 7\n\n# è¤‡æ•°ã®é‡å­ãƒ“ãƒƒãƒˆã§æ¢ç´¢\nq = qubits(16, 0.5)\nresults = measure_all(q)\n\n# çµæœã‚’è¡¨ç¤º\nprint("æ¢ç´¢çµæœ:", results)\nprint("åˆè¨ˆ:", sum(results))',
            fib: '# ãƒ•ã‚£ãƒœãƒŠãƒƒãƒ\ndef fib(n):\n    if n <= 1:\n        return n\n    a = 0\n    b = 1\n    j = 2\n    while j <= n:\n        c = a + b\n        a = b\n        b = c\n        j = j + 1\n    return b\n\nfor k in range(10):\n    print("fib(", k, ") =", fib(k))'
        };
        if (ex[name]) document.getElementById('editor').value = ex[name];
    };
    
    // è‡ªå‹•æ›´æ–°
    document.getElementById('autoRun').addEventListener('change', function() {
        if (this.checked) {
            startAnimation();
        } else {
            stopAnimation();
        }
    });
    
    // åˆæœŸåŒ–
    window.updateQubitDisplay = updateQubitDisplay;
    window.updateSpeed = updateSpeed;
    updateQubitDisplay();
    startAnimation();
})();
</script>
</body>
</html>

