# NeuroQ RunPod Serverless - Optimized for Stability
# ===================================================
# é«˜é€Ÿèµ·å‹• & å®‰å®šå‹•ä½œã®ãŸã‚ã®æœ€é©åŒ–æ¸ˆã¿Dockerfile

FROM runpod/pytorch:2.1.0-py3.10-cuda11.8.0-devel

# ç’°å¢ƒå¤‰æ•°ï¼ˆèµ·å‹•é«˜é€ŸåŒ–ï¼‰
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

# Git LFSã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && \
    apt-get install -y git-lfs && \
    git lfs install && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ€å°é™ï¼‰
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt && \
    pip uninstall -y transformers || true && \
    rm -rf /root/.cache/pip

# Git LFSãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
# ï¼ˆäº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãªã©ã®LFSãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰
RUN if [ -d "/tmp/neuroq-repo" ]; then rm -rf /tmp/neuroq-repo; fi

# ARGã§ãƒªãƒã‚¸ãƒˆãƒªURLã‚’æŒ‡å®šå¯èƒ½ã«ã™ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯NeuroQãƒªãƒã‚¸ãƒˆãƒªï¼‰
ARG GIT_REPO_URL="https://github.com/tapiocaTakeshi/NeuroQ.git"
ARG GIT_BRANCH="main"

# ãƒªãƒã‚¸ãƒˆãƒªãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒ­ãƒ¼ãƒ³ï¼†LFS pull
RUN if [ -n "$GIT_REPO_URL" ]; then \
        echo "ğŸ“¦ Cloning repository with Git LFS..." && \
        git clone --depth 1 --branch "$GIT_BRANCH" "$GIT_REPO_URL" /tmp/neuroq-repo && \
        cd /tmp/neuroq-repo && \
        git lfs pull && \
        echo "âœ… Git LFS files pulled successfully"; \
    else \
        echo "âš ï¸ No GIT_REPO_URL provided, skipping git clone"; \
    fi

# ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒ”ãƒ¼ï¼ˆè»½é‡åŒ–ï¼‰
# LFSãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¯ãƒ­ãƒ¼ãƒ³ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã¡ã‚‰ã‹ã‚‰ã€ãªã‘ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰
COPY neuroquantum_layered.py /app/
COPY neuroquantum_brain.py /app/
COPY qbnn_layered.py /app/
COPY qbnn_brain.py /app/
COPY handler.py /app/
COPY pretrain_openai.py /app/

# äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆåŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ï¼‰
COPY neuroq_pretrained.py /app/

# ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼
COPY neuroq_tokenizer.model /app/
COPY neuroq_tokenizer.vocab /app/
COPY neuroq_tokenizer_8k.model /app/
COPY neuroq_tokenizer_8k.vocab /app/

# äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« (.pth)
COPY neuroq_pretrained.pth /app/

# Entrypointã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆèµ·å‹•æ™‚ã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
COPY entrypoint.sh /app/
RUN chmod +x /app/entrypoint.sh

# ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºå‰Šæ¸›ï¼‰
RUN if [ -d "/tmp/neuroq-repo" ]; then rm -rf /tmp/neuroq-repo; fi

# ç’°å¢ƒå¤‰æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰
ENV NEUROQ_MODE="layered"
ENV NEUROQ_VOCAB_SIZE="8000"
ENV MODEL_FILE="neuroq_pretrained.pth"
ENV GIT_REPO_URL="https://github.com/tapiocaTakeshi/NeuroQ.git"
ENV GIT_BRANCH="main"

# ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆï¼ˆèµ·å‹•æ™‚ã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
ENTRYPOINT ["/app/entrypoint.sh"]
