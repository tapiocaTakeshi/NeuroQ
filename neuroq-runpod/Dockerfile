# NeuroQ RunPod Serverless - Optimized for Stability
# ===================================================
# é«˜é€Ÿèµ·å‹• & å®‰å®šå‹•ä½œã®ãŸã‚ã®æœ€é©åŒ–æ¸ˆã¿Dockerfile

FROM runpod/pytorch:2.1.0-py3.10-cuda11.8.0-devel

# ç’°å¢ƒå¤‰æ•°ï¼ˆèµ·å‹•é«˜é€ŸåŒ–ï¼‰
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

# Git LFSã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && \
    apt-get install -y git-lfs && \
    git lfs install && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ€å°é™ï¼‰
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt && \
    pip uninstall -y transformers || true && \
    rm -rf /root/.cache/pip

# Git LFSãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
# ï¼ˆäº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãªã©ã®LFSãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰
RUN if [ -d "/tmp/neuroq-repo" ]; then rm -rf /tmp/neuroq-repo; fi

# ARGã§ãƒªãƒã‚¸ãƒˆãƒªURLã‚’æŒ‡å®šå¯èƒ½ã«ã™ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯NeuroQãƒªãƒã‚¸ãƒˆãƒªï¼‰
ARG GIT_REPO_URL="https://github.com/tapiocaTakeshi/NeuroQ.git"
ARG GIT_BRANCH="main"

# ãƒªãƒã‚¸ãƒˆãƒªãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒ­ãƒ¼ãƒ³ï¼†LFS pull
RUN if [ -n "$GIT_REPO_URL" ]; then \
        echo "ğŸ“¦ Cloning repository with Git LFS..." && \
        git clone --depth 1 --branch "$GIT_BRANCH" "$GIT_REPO_URL" /tmp/neuroq-repo && \
        cd /tmp/neuroq-repo && \
        git lfs pull && \
        echo "âœ… Git LFS files pulled successfully"; \
    else \
        echo "âš ï¸ No GIT_REPO_URL provided, skipping git clone"; \
    fi

# ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒ”ãƒ¼ï¼ˆè»½é‡åŒ–ï¼‰
# LFSãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¯ãƒ­ãƒ¼ãƒ³ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã¡ã‚‰ã‹ã‚‰ã€ãªã‘ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰
COPY neuroquantum_layered.py /app/
COPY neuroquantum_brain.py /app/
COPY qbnn_layered.py /app/
COPY qbnn_brain.py /app/
COPY handler.py /app/
COPY pretrain_openai.py /app/

# äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆåŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ï¼‰
COPY neuroq_pretrained.py /app/

# ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼
COPY neuroq_tokenizer.model /app/
COPY neuroq_tokenizer.vocab /app/

# Entrypointã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆèµ·å‹•æ™‚ã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
COPY entrypoint.sh /app/
RUN chmod +x /app/entrypoint.sh

# äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ï¼ˆLFSãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
# NOTE: ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯èµ·å‹•æ™‚ã«entrypoint.shã§è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™
# ãƒ“ãƒ«ãƒ‰æ™‚ã«LFSãƒ•ã‚¡ã‚¤ãƒ«ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ã‚³ãƒ”ãƒ¼ã—ã¾ã™ãŒã€å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: git cloneã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼ˆGIT_REPO_URLãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
RUN if [ -f "/tmp/neuroq-repo/neuroq_pretrained.pt" ]; then \
        echo "ğŸ“¦ Using LFS-pulled pretrained model from git clone" && \
        MODEL_SIZE=$(stat -c%s /tmp/neuroq-repo/neuroq_pretrained.pt) && \
        if [ "$MODEL_SIZE" -ge 10000 ]; then \
            cp /tmp/neuroq-repo/neuroq_pretrained.pt /app/neuroq_pretrained.pt && \
            echo "âœ… Model file from git clone: $MODEL_SIZE bytes" && \
            ls -lh /app/neuroq_pretrained.pt; \
        else \
            echo "âš ï¸ Model file from git clone is too small ($MODEL_SIZE bytes)"; \
            echo "   ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯èµ·å‹•æ™‚ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™"; \
        fi; \
    else \
        echo "â„¹ï¸ No model file from git clone"; \
        echo "   ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯èµ·å‹•æ™‚ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™"; \
    fi

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿ï¼‰
# LFSãƒã‚¤ãƒ³ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã›ãšã€èµ·å‹•æ™‚ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
COPY --chown=root:root neuroq_pretrained.pt /tmp/neuroq_pretrained_local.pt || true

RUN if [ -f "/tmp/neuroq_pretrained_local.pt" ] && [ ! -f "/app/neuroq_pretrained.pt" ]; then \
        LOCAL_SIZE=$(stat -c%s /tmp/neuroq_pretrained_local.pt 2>/dev/null || echo "0") && \
        echo "ğŸ“‹ Checking neuroq_pretrained.pt from local build context..." && \
        echo "   Local file size: $LOCAL_SIZE bytes" && \
        if [ "$LOCAL_SIZE" -ge 10000 ]; then \
            cp /tmp/neuroq_pretrained_local.pt /app/neuroq_pretrained.pt && \
            echo "âœ… Using local model file: $LOCAL_SIZE bytes"; \
        else \
            echo "âš ï¸ Local file is a Git LFS pointer ($LOCAL_SIZE bytes)"; \
            echo "   ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯èµ·å‹•æ™‚ã«è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™"; \
        fi; \
    fi && \
    rm -f /tmp/neuroq_pretrained_local.pt

# ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã‚‚ç¶™ç¶šï¼‰
RUN if [ -f "/app/neuroq_pretrained.pt" ]; then \
        FINAL_SIZE=$(stat -c%s /app/neuroq_pretrained.pt) && \
        echo "ğŸ“Š Model file available in image: $FINAL_SIZE bytes" && \
        ls -lh /app/neuroq_pretrained.pt; \
    else \
        echo "â„¹ï¸ Model file not included in image"; \
        echo "   âœ… èµ·å‹•æ™‚ã«entrypoint.shãŒè‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"; \
    fi

# ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºå‰Šæ¸›ï¼‰
RUN if [ -d "/tmp/neuroq-repo" ]; then rm -rf /tmp/neuroq-repo; fi

# ç’°å¢ƒå¤‰æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰
ENV NEUROQ_MODE="layered"
ENV NEUROQ_VOCAB_SIZE="8000"
ENV MODEL_FILE="neuroq_pretrained.pt"
ENV GIT_REPO_URL="https://github.com/tapiocaTakeshi/NeuroQ.git"
ENV GIT_BRANCH="main"

# ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆï¼ˆèµ·å‹•æ™‚ã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
ENTRYPOINT ["/app/entrypoint.sh"]
