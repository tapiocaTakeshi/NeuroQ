# NeuroQ RunPod Serverless - Optimized for Stability
# ===================================================
# é«˜é€Ÿèµ·å‹• & å®‰å®šå‹•ä½œã®ãŸã‚ã®æœ€é©åŒ–æ¸ˆã¿Dockerfile

FROM runpod/pytorch:2.1.0-py3.10-cuda11.8.0-devel

# ç’°å¢ƒå¤‰æ•°ï¼ˆèµ·å‹•é«˜é€ŸåŒ–ï¼‰
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

# Git LFSã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && \
    apt-get install -y git-lfs && \
    git lfs install && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ€å°é™ï¼‰
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt && \
    pip uninstall -y transformers || true && \
    rm -rf /root/.cache/pip

# Git LFSãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
# ï¼ˆäº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãªã©ã®LFSãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰
RUN if [ -d "/tmp/neuroq-repo" ]; then rm -rf /tmp/neuroq-repo; fi

# ARGã§ãƒªãƒã‚¸ãƒˆãƒªURLã‚’æŒ‡å®šå¯èƒ½ã«ã™ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯NeuroQãƒªãƒã‚¸ãƒˆãƒªï¼‰
ARG GIT_REPO_URL="https://github.com/tapiocaTakeshi/NeuroQ.git"
ARG GIT_BRANCH="main"

# ãƒªãƒã‚¸ãƒˆãƒªãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒ­ãƒ¼ãƒ³ï¼†LFS pull
RUN if [ -n "$GIT_REPO_URL" ]; then \
        echo "ğŸ“¦ Cloning repository with Git LFS..." && \
        git clone --depth 1 --branch "$GIT_BRANCH" "$GIT_REPO_URL" /tmp/neuroq-repo && \
        cd /tmp/neuroq-repo && \
        git lfs pull && \
        echo "âœ… Git LFS files pulled successfully"; \
    else \
        echo "âš ï¸ No GIT_REPO_URL provided, skipping git clone"; \
    fi

# ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒ”ãƒ¼ï¼ˆè»½é‡åŒ–ï¼‰
# LFSãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¯ãƒ­ãƒ¼ãƒ³ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã¡ã‚‰ã‹ã‚‰ã€ãªã‘ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰
COPY neuroquantum_layered.py /app/
COPY neuroquantum_brain.py /app/
COPY qbnn_layered.py /app/
COPY qbnn_brain.py /app/
COPY handler.py /app/
COPY pretrain_openai.py /app/

# äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆåŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ï¼‰
COPY neuroq_pretrained.py /app/

# ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼
COPY neuroq_tokenizer.model /app/
COPY neuroq_tokenizer.vocab /app/

# äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ï¼ˆLFSãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: git cloneã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼ˆGIT_REPO_URLãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
RUN if [ -f "/tmp/neuroq-repo/neuroq_pretrained.pt" ]; then \
        echo "ğŸ“¦ Using LFS-pulled pretrained model from git clone" && \
        MODEL_SIZE=$(stat -c%s /tmp/neuroq-repo/neuroq_pretrained.pt) && \
        if [ "$MODEL_SIZE" -ge 10000 ]; then \
            cp /tmp/neuroq-repo/neuroq_pretrained.pt /app/neuroq_pretrained.pt && \
            echo "âœ… Model file from git clone: $MODEL_SIZE bytes" && \
            ls -lh /app/neuroq_pretrained.pt; \
        else \
            echo "âš ï¸ Model file from git clone is too small ($MODEL_SIZE bytes), trying local copy..."; \
        fi; \
    fi

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼ˆgit cloneãŒæˆåŠŸã—ãªã‹ã£ãŸå ´åˆï¼‰
# Copy model file from build context to temp location for validation
COPY --chown=root:root neuroq_pretrained.pt /tmp/neuroq_pretrained_local.pt

# Validate and copy from local build context if not already present
RUN if [ ! -f "/app/neuroq_pretrained.pt" ]; then \
        echo "ğŸ“‹ Validating neuroq_pretrained.pt from local build context..." && \
        LOCAL_SIZE=$(stat -c%s /tmp/neuroq_pretrained_local.pt) && \
        echo "   Local file size: $LOCAL_SIZE bytes" && \
        if [ "$LOCAL_SIZE" -lt 10000 ]; then \
            echo "" && \
            echo "âŒ ERROR: neuroq_pretrained.pt is a Git LFS pointer file ($LOCAL_SIZE bytes)" && \
            echo "   The actual model file was not pulled from Git LFS." && \
            echo "" && \
            echo "   This happened because:" && \
            echo "   - No GIT_REPO_URL was provided to clone and pull LFS files" && \
            echo "   - The local file is an LFS pointer, not the actual model" && \
            echo "" && \
            echo "   To fix this, use ONE of the following methods:" && \
            echo "" && \
            echo "   1. Build with repository URL (RECOMMENDED):" && \
            echo "      docker build -f neuroq-runpod/Dockerfile \\" && \
            echo "        --build-arg GIT_REPO_URL=https://github.com/tapiocaTakeshi/NeuroQ.git \\" && \
            echo "        --build-arg GIT_BRANCH=main \\" && \
            echo "        -t neuroq:latest ." && \
            echo "" && \
            echo "   2. Pull LFS files locally first:" && \
            echo "      git lfs install" && \
            echo "      git lfs pull" && \
            echo "      docker build -f neuroq-runpod/Dockerfile -t neuroq:latest ." && \
            echo "" && \
            echo "   3. Use the build helper script:" && \
            echo "      ./neuroq-runpod/build.sh" && \
            echo "" && \
            exit 1; \
        else \
            cp /tmp/neuroq_pretrained_local.pt /app/neuroq_pretrained.pt && \
            echo "âœ… Using local model file: $LOCAL_SIZE bytes"; \
        fi; \
    fi && \
    rm -f /tmp/neuroq_pretrained_local.pt

# æœ€çµ‚ç¢ºèª
RUN echo "ğŸ“Š Final validation of neuroq_pretrained.pt..." && \
    ls -lh /app/neuroq_pretrained.pt && \
    FINAL_SIZE=$(stat -c%s /app/neuroq_pretrained.pt) && \
    echo "âœ… Model file ready: $FINAL_SIZE bytes"

# ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºå‰Šæ¸›ï¼‰
RUN if [ -d "/tmp/neuroq-repo" ]; then rm -rf /tmp/neuroq-repo; fi

# ç’°å¢ƒå¤‰æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰
ENV NEUROQ_MODE="layered"
ENV NEUROQ_VOCAB_SIZE="8000"

# ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
CMD ["python", "-u", "handler.py"]
