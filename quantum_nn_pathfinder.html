<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡å­ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ‘ã‚¹ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0a0a1a, #1a0a2e, #0a1a2e);
            min-height: 100vh;
            font-family: monospace;
            color: #fff;
            padding: 15px;
        }
        h1 { text-align: center; font-size: 1.4rem; color: #00d4ff; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #888; font-size: 0.75rem; margin-bottom: 15px; }
        .container { display: flex; gap: 15px; max-width: 1500px; margin: 0 auto; flex-wrap: wrap; }
        .panel { background: rgba(0,0,0,0.6); border: 2px solid #00d4ff; border-radius: 10px; padding: 15px; }
        .controls { width: 300px; }
        .viz-panel { flex: 1; min-width: 450px; }
        .stats-panel { width: 280px; }
        h3 { color: #00d4ff; margin-bottom: 10px; font-size: 0.9rem; }
        .control { margin-bottom: 10px; }
        .control label { display: block; color: #888; font-size: 0.7rem; margin-bottom: 3px; }
        input[type="range"] { width: 100%; -webkit-appearance: none; height: 6px; background: #1a1a2e; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #00d4ff; border-radius: 50%; cursor: pointer; }
        .value { text-align: right; color: #00d4ff; font-size: 0.8rem; }
        .btn { width: 100%; padding: 8px; margin-bottom: 5px; border: none; border-radius: 15px; font-size: 0.8rem; cursor: pointer; color: #fff; }
        .btn:active { transform: scale(0.98); }
        .btn-start { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-stop { background: linear-gradient(135deg, #ec4899, #be185d); }
        .btn-reset { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
        .btn-maze { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-random { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        canvas { display: block; margin: 0 auto; border-radius: 8px; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.75rem; margin: 3px 0; }
        .stat-label { color: #888; }
        .stat-value { color: #00d4ff; }
        .nn-box { background: rgba(139,92,246,0.1); border: 1px solid #8b5cf6; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .nn-title { color: #8b5cf6; font-size: 0.8rem; margin-bottom: 8px; }
        .weight-display { font-size: 0.7rem; color: #aaa; line-height: 1.5; }
        .weight-pos { color: #10b981; }
        .weight-neg { color: #ec4899; }
        .chain-box { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 8px; margin-bottom: 10px; max-height: 80px; overflow-y: auto; }
        .chain-values { font-size: 0.65rem; line-height: 1.5; color: #aaa; }
        .r-pos { color: #00d4ff; }
        .r-neg { color: #ec4899; }
        .info { font-size: 0.7rem; color: #10b981; padding: 8px; background: rgba(16,185,129,0.1); border-radius: 6px; margin-top: 10px; }
        .formula { background: rgba(0,212,255,0.1); padding: 8px; border-radius: 6px; font-size: 0.65rem; margin-top: 10px; line-height: 1.5; color: #00d4ff; }
        .activation-select { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .act-btn { padding: 4px 8px; font-size: 0.7rem; border: 1px solid #333; border-radius: 10px; background: #1a1a2e; color: #888; cursor: pointer; }
        .act-btn.active { border-color: #00d4ff; color: #00d4ff; background: rgba(0,212,255,0.1); }
    </style>
</head>
<body>
    <h1>ğŸ§  é‡å­ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ‘ã‚¹ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼</h1>
    <p class="subtitle">r_{k+1} = Ïƒ(WÂ·r_k + b) ã‚’ N å›é©ç”¨</p>
    
    <div class="container">
        <div class="panel controls">
            <h3>ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š</h3>
            
            <div class="control">
                <label>é‡ã¿ Wï¼ˆå‚¾ãï¼‰</label>
                <input type="range" id="wSlider" min="-300" max="300" value="150">
                <div class="value">W = <span id="wVal">1.50</span></div>
            </div>
            
            <div class="control">
                <label>ãƒã‚¤ã‚¢ã‚¹ b</label>
                <input type="range" id="bSlider" min="-100" max="100" value="0">
                <div class="value">b = <span id="bVal">0.00</span></div>
            </div>
            
            <div class="control">
                <label>æ´»æ€§åŒ–é–¢æ•° Ïƒ</label>
                <div class="activation-select">
                    <button class="act-btn active" data-act="tanh">tanh</button>
                    <button class="act-btn" data-act="sigmoid">sigmoid</button>
                    <button class="act-btn" data-act="quantum">é‡å­</button>
                    <button class="act-btn" data-act="relu">ReLU</button>
                    <button class="act-btn" data-act="sin">sin</button>
                </div>
            </div>
            
            <div class="control">
                <label>å†å¸°æ·±åº¦ N</label>
                <input type="range" id="nSlider" min="1" max="50" value="10">
                <div class="value">N = <span id="nVal">10</span></div>
            </div>
            
            <button class="btn btn-random" id="randomBtn">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ é‡ã¿</button>
            
            <h3 style="margin-top:15px">æ¢ç´¢è¨­å®š</h3>
            
            <div class="control">
                <label>æœ€å¤§ã‚¹ãƒ†ãƒƒãƒ—</label>
                <input type="range" id="stepsSlider" min="100" max="500" value="200">
                <div class="value"><span id="stepsVal">200</span></div>
            </div>
            
            <div class="control">
                <label>é€Ÿåº¦ (ms)</label>
                <input type="range" id="speedSlider" min="30" max="300" value="80">
                <div class="value"><span id="speedVal">80</span> ms</div>
            </div>
            
            <button class="btn btn-maze" id="mazeBtn">ğŸ”€ æ–°ã—ã„è¿·è·¯</button>
            <button class="btn btn-start" id="startBtn">â–¶ æ¢ç´¢é–‹å§‹</button>
            <button class="btn btn-stop" id="stopBtn" style="display:none">â¹ åœæ­¢</button>
            <button class="btn btn-reset" id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            
            <div class="formula">
                <b>ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†™åƒ:</b><br>
                z_k = W Â· r_k + b<br>
                r_{k+1} = Ïƒ(z_k)<br><br>
                <b>æ´»æ€§åŒ–é–¢æ•°:</b><br>
                tanh: (-1, 1) ã«åæŸ<br>
                sigmoid: (0, 1) â†’ 2x-1 ã§ (-1, 1)<br>
                é‡å­: cos(Ï€(1-z)/2)<br>
                sin: å‘¨æœŸçš„æŒ¯å‹•
            </div>
        </div>
        
        <div class="panel viz-panel">
            <canvas id="mazeCanvas" width="440" height="440"></canvas>
            <div style="display:flex;gap:10px;margin-top:10px">
                <canvas id="chartCanvas" width="215" height="120"></canvas>
                <canvas id="nnCanvas" width="215" height="120"></canvas>
            </div>
        </div>
        
        <div class="panel stats-panel">
            <h3>ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹</h3>
            
            <div class="nn-box">
                <div class="nn-title">ç¾åœ¨ã®å†™åƒ f(r)</div>
                <div class="weight-display" id="nnDisplay">
                    z = <span id="wDisplay">1.50</span> Â· r + <span id="bDisplay">0.00</span><br>
                    r' = <span id="actDisplay">tanh</span>(z)
                </div>
            </div>
            
            <div class="chain-box">
                <div style="font-size:0.7rem;color:#8b5cf6;margin-bottom:5px">râ‚€ â†’ râ‚ â†’ ... â†’ r_N</div>
                <div class="chain-values" id="chainValues">æ¢ç´¢é–‹å§‹ã§è¡¨ç¤º</div>
            </div>
            
            <div class="stat-row"><span class="stat-label">åˆæœŸ râ‚€:</span><span class="stat-value" id="r0Stat">-</span></div>
            <div class="stat-row"><span class="stat-label">æœ€çµ‚ r_N:</span><span class="stat-value" id="rNStat">-</span></div>
            <div class="stat-row"><span class="stat-label">åæŸå…ˆ:</span><span class="stat-value" id="convStat">-</span></div>
            
            <h3 style="margin-top:10px">æ¢ç´¢çµ±è¨ˆ</h3>
            <div class="stat-row"><span class="stat-label">ã‚¹ãƒ†ãƒƒãƒ—:</span><span class="stat-value" id="stepStat">0</span></div>
            <div class="stat-row"><span class="stat-label">è·é›¢:</span><span class="stat-value" id="distStat">-</span></div>
            <div class="stat-row"><span class="stat-label">+æ–¹å‘:</span><span class="stat-value" id="cPosStat">0</span></div>
            <div class="stat-row"><span class="stat-label">-æ–¹å‘:</span><span class="stat-value" id="cNegStat">0</span></div>
            <div class="stat-row"><span class="stat-label">çµŒè·¯é•·:</span><span class="stat-value" id="pathStat">0</span></div>
            
            <div class="info" id="infoBox">â–¶ æ¢ç´¢é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
        </div>
    </div>

<script>
(function() {
    // æ´»æ€§åŒ–é–¢æ•°
    var activations = {
        tanh: function(z) { return Math.tanh(z); },
        sigmoid: function(z) { return 2 / (1 + Math.exp(-z)) - 1; },  // -1ã€œ1ã«æ­£è¦åŒ–
        quantum: function(z) { 
            z = Math.max(-1, Math.min(1, z));
            return Math.cos(Math.PI * (1 - z) / 2); 
        },
        relu: function(z) { return Math.max(-1, Math.min(1, z)); },  // ã‚¯ãƒªãƒƒãƒ—
        sin: function(z) { return Math.sin(z); }
    };

    var currentActivation = 'tanh';

    // ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†™åƒ
    function nnMap(r, w, b) {
        var z = w * r + b;
        return activations[currentActivation](z);
    }

    // Nå›é©ç”¨
    function applyN(r0, N, w, b) {
        var chain = [r0];
        var r = r0;
        for (var i = 0; i < N; i++) {
            r = nnMap(r, w, b);
            chain.push(r);
        }
        return chain;
    }

    // è¿·è·¯ç”Ÿæˆ
    function createMaze(size) {
        var maze = [];
        for (var y = 0; y < size; y++) {
            maze[y] = [];
            for (var x = 0; x < size; x++) {
                if (y === 0 || y === size-1 || x === 0 || x === size-1) {
                    maze[y][x] = 1;
                } else if (y % 2 === 0 && x % 2 === 0) {
                    maze[y][x] = 1;
                } else if (y % 2 === 1 && x % 2 === 1) {
                    maze[y][x] = 0;
                } else {
                    maze[y][x] = Math.random() < 0.3 ? 1 : 0;
                }
            }
        }
        maze[1][1] = 0; maze[size-2][size-2] = 0;
        maze[1][2] = 0; maze[2][1] = 0;
        maze[size-2][size-3] = 0; maze[size-3][size-2] = 0;
        return maze;
    }

    // çŠ¶æ…‹
    var SIZE = 21, CELL = 21;
    var maze = [];
    var agent = {x: 1, y: 1};
    var start = {x: 1, y: 1};
    var goal = {x: SIZE-2, y: SIZE-2};
    var path = [];
    var visited = {};
    var running = false;
    var timer = null;
    var step = 0;
    var cPos = 0, cNeg = 0;
    var rHistory = [];

    var mazeCanvas = document.getElementById('mazeCanvas');
    var mazeCtx = mazeCanvas.getContext('2d');
    var chartCanvas = document.getElementById('chartCanvas');
    var chartCtx = chartCanvas.getContext('2d');
    var nnCanvas = document.getElementById('nnCanvas');
    var nnCtx = nnCanvas.getContext('2d');

    function updateSliders() {
        var w = document.getElementById('wSlider').value / 100;
        var b = document.getElementById('bSlider').value / 100;
        document.getElementById('wVal').textContent = w.toFixed(2);
        document.getElementById('bVal').textContent = b.toFixed(2);
        document.getElementById('nVal').textContent = document.getElementById('nSlider').value;
        document.getElementById('stepsVal').textContent = document.getElementById('stepsSlider').value;
        document.getElementById('speedVal').textContent = document.getElementById('speedSlider').value;
        
        document.getElementById('wDisplay').textContent = w.toFixed(2);
        document.getElementById('wDisplay').className = w >= 0 ? 'weight-pos' : 'weight-neg';
        document.getElementById('bDisplay').textContent = b.toFixed(2);
        document.getElementById('bDisplay').className = b >= 0 ? 'weight-pos' : 'weight-neg';
        
        drawNN();
    }

    // æ´»æ€§åŒ–é–¢æ•°é¸æŠ
    document.querySelectorAll('.act-btn').forEach(function(btn) {
        btn.onclick = function() {
            document.querySelectorAll('.act-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentActivation = btn.dataset.act;
            document.getElementById('actDisplay').textContent = currentActivation;
            drawNN();
        };
    });

    document.getElementById('wSlider').oninput = updateSliders;
    document.getElementById('bSlider').oninput = updateSliders;
    document.getElementById('nSlider').oninput = updateSliders;
    document.getElementById('stepsSlider').oninput = updateSliders;
    document.getElementById('speedSlider').oninput = updateSliders;

    // ãƒ©ãƒ³ãƒ€ãƒ é‡ã¿
    document.getElementById('randomBtn').onclick = function() {
        document.getElementById('wSlider').value = Math.floor(Math.random() * 400 - 200);
        document.getElementById('bSlider').value = Math.floor(Math.random() * 100 - 50);
        updateSliders();
    };

    function genMaze() {
        stopRun();
        maze = createMaze(SIZE);
        resetState();
    }

    function resetState() {
        agent = {x: 1, y: 1};
        path = [{x: 1, y: 1}];
        visited = {}; visited['1,1'] = true;
        step = 0; cPos = 0; cNeg = 0;
        rHistory = [];
        document.getElementById('chainValues').innerHTML = '<span style="color:#666">æ¢ç´¢é–‹å§‹ã§è¡¨ç¤º</span>';
        document.getElementById('r0Stat').textContent = '-';
        document.getElementById('rNStat').textContent = '-';
        document.getElementById('convStat').textContent = '-';
        document.getElementById('stepStat').textContent = '0';
        document.getElementById('distStat').textContent = '-';
        document.getElementById('cPosStat').textContent = '0';
        document.getElementById('cNegStat').textContent = '0';
        document.getElementById('pathStat').textContent = '1';
        document.getElementById('infoBox').textContent = 'â–¶ æ¢ç´¢é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„';
        document.getElementById('infoBox').style.color = '#10b981';
        drawMaze();
        drawChart();
        drawNN();
    }

    function stopRun() {
        running = false;
        if (timer) { clearTimeout(timer); timer = null; }
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'none';
    }

    function displayChain(chain) {
        var html = '';
        var maxShow = 15;
        for (var i = 0; i < Math.min(chain.length, maxShow); i++) {
            var r = chain[i];
            var cls = r > 0.01 ? 'r-pos' : (r < -0.01 ? 'r-neg' : '');
            html += '<span class="' + cls + '">' + r.toFixed(3) + '</span>';
            if (i < Math.min(chain.length, maxShow) - 1) html += ' â†’ ';
        }
        if (chain.length > maxShow) html += ' ...';
        document.getElementById('chainValues').innerHTML = html;
        
        var rN = chain[chain.length - 1];
        var conv = '';
        if (Math.abs(rN) > 0.99) conv = 'é£½å’Œ (Â±1)';
        else if (Math.abs(rN) < 0.01) conv = '0ä»˜è¿‘';
        else conv = 'ä¸­é–“å€¤';
        document.getElementById('convStat').textContent = conv;
    }

    function startRun() {
        if (running) return;
        running = true;
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';
        document.getElementById('infoBox').textContent = 'ğŸ” NNé‡å­æ¢ç´¢ä¸­...';
        document.getElementById('infoBox').style.color = '#00d4ff';

        var N = parseInt(document.getElementById('nSlider').value);
        var w = parseFloat(document.getElementById('wSlider').value) / 100;
        var b = parseFloat(document.getElementById('bSlider').value) / 100;
        var maxSteps = parseInt(document.getElementById('stepsSlider').value);
        var speed = parseInt(document.getElementById('speedSlider').value);

        function tick() {
            if (!running) return;

            if (agent.x === goal.x && agent.y === goal.y) {
                document.getElementById('infoBox').textContent = 'ğŸ‰ ã‚´ãƒ¼ãƒ«ï¼ ' + path.length + 'ã‚¹ãƒ†ãƒƒãƒ—';
                document.getElementById('infoBox').style.color = '#f59e0b';
                stopRun();
                return;
            }

            if (step >= maxSteps) {
                document.getElementById('infoBox').textContent = 'â± æ™‚é–“åˆ‡ã‚Œ';
                document.getElementById('infoBox').style.color = '#ec4899';
                stopRun();
                return;
            }

            var dirs = [];
            var moves = [{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}];
            for (var i = 0; i < moves.length; i++) {
                var nx = agent.x + moves[i].dx;
                var ny = agent.y + moves[i].dy;
                if (nx >= 0 && nx < SIZE && ny >= 0 && ny < SIZE && maze[ny][nx] === 0) {
                    var dist = Math.sqrt(Math.pow(goal.x - nx, 2) + Math.pow(goal.y - ny, 2));
                    dirs.push({dx: moves[i].dx, dy: moves[i].dy, dist: dist, visited: visited[nx+','+ny]});
                }
            }

            if (dirs.length === 0) {
                if (path.length > 1) {
                    path.pop();
                    agent = {x: path[path.length-1].x, y: path[path.length-1].y};
                }
                step++;
                drawMaze();
                timer = setTimeout(tick, speed);
                return;
            }

            dirs.sort(function(a, b) { return a.dist - b.dist; });
            var best = dirs[0];
            var curDist = Math.sqrt(Math.pow(goal.x - agent.x, 2) + Math.pow(goal.y - agent.y, 2));
            
            var r0 = (curDist - best.dist) / (Math.max(curDist, 1) * 0.5);
            if (best.visited) r0 -= 0.4;
            r0 = Math.max(-0.99, Math.min(0.99, r0));

            // â˜… ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†™åƒã‚’Nå›é©ç”¨ â˜…
            var chain = applyN(r0, N, w, b);
            displayChain(chain);

            var rN = chain[chain.length - 1];
            if (rN > 0) cPos++; else cNeg++;

            var chosen;
            if (rN > 0) {
                chosen = best;
            } else {
                chosen = dirs[Math.floor(Math.random() * dirs.length)];
            }

            agent.x += chosen.dx;
            agent.y += chosen.dy;
            visited[agent.x + ',' + agent.y] = true;
            path.push({x: agent.x, y: agent.y});

            rHistory.push({r0: r0, rN: rN});

            document.getElementById('stepStat').textContent = step;
            var d = Math.sqrt(Math.pow(goal.x - agent.x, 2) + Math.pow(goal.y - agent.y, 2));
            document.getElementById('distStat').textContent = d.toFixed(1);
            document.getElementById('r0Stat').textContent = r0.toFixed(4);
            document.getElementById('rNStat').textContent = rN.toFixed(6);
            document.getElementById('cPosStat').textContent = cPos;
            document.getElementById('cNegStat').textContent = cNeg;
            document.getElementById('pathStat').textContent = path.length;

            step++;
            drawMaze();
            drawChart();
            timer = setTimeout(tick, speed);
        }

        tick();
    }

    function drawMaze() {
        mazeCtx.fillStyle = '#0a0a1a';
        mazeCtx.fillRect(0, 0, mazeCanvas.width, mazeCanvas.height);

        for (var y = 0; y < SIZE; y++) {
            for (var x = 0; x < SIZE; x++) {
                if (maze[y][x] === 1) {
                    mazeCtx.fillStyle = '#1a1a3e';
                    mazeCtx.fillRect(x * CELL, y * CELL, CELL, CELL);
                } else if (visited[x + ',' + y]) {
                    mazeCtx.fillStyle = 'rgba(139,92,246,0.2)';
                    mazeCtx.fillRect(x * CELL, y * CELL, CELL, CELL);
                }
            }
        }

        if (path.length > 1) {
            mazeCtx.strokeStyle = '#f59e0b';
            mazeCtx.lineWidth = CELL * 0.3;
            mazeCtx.lineCap = 'round';
            mazeCtx.beginPath();
            mazeCtx.moveTo(path[0].x * CELL + CELL/2, path[0].y * CELL + CELL/2);
            for (var i = 1; i < path.length; i++) {
                mazeCtx.lineTo(path[i].x * CELL + CELL/2, path[i].y * CELL + CELL/2);
            }
            mazeCtx.stroke();
        }

        mazeCtx.fillStyle = '#10b981';
        mazeCtx.beginPath();
        mazeCtx.arc(start.x * CELL + CELL/2, start.y * CELL + CELL/2, CELL * 0.35, 0, Math.PI * 2);
        mazeCtx.fill();

        mazeCtx.fillStyle = '#ec4899';
        mazeCtx.beginPath();
        mazeCtx.arc(goal.x * CELL + CELL/2, goal.y * CELL + CELL/2, CELL * 0.35, 0, Math.PI * 2);
        mazeCtx.fill();

        mazeCtx.fillStyle = '#00d4ff';
        mazeCtx.beginPath();
        mazeCtx.arc(agent.x * CELL + CELL/2, agent.y * CELL + CELL/2, CELL * 0.4, 0, Math.PI * 2);
        mazeCtx.fill();
        mazeCtx.strokeStyle = '#fff';
        mazeCtx.lineWidth = 2;
        mazeCtx.stroke();
    }

    function drawChart() {
        var w = chartCanvas.width, h = chartCanvas.height;
        chartCtx.fillStyle = 'rgba(10,10,15,0.95)';
        chartCtx.fillRect(0, 0, w, h);

        chartCtx.strokeStyle = 'rgba(255,255,255,0.1)';
        chartCtx.beginPath();
        chartCtx.moveTo(25, h/2);
        chartCtx.lineTo(w, h/2);
        chartCtx.stroke();

        chartCtx.fillStyle = '#666';
        chartCtx.font = '9px monospace';
        chartCtx.fillText('+1', 3, 12);
        chartCtx.fillText('-1', 3, h - 5);
        chartCtx.fillText('r', w/2, h - 3);

        if (rHistory.length < 2) {
            chartCtx.fillStyle = '#666';
            chartCtx.fillText('râ‚€ vs r_N', w/2 - 15, h/2);
            return;
        }

        var xs = (w - 35) / Math.max(rHistory.length, 50);

        chartCtx.strokeStyle = 'rgba(139,92,246,0.5)';
        chartCtx.lineWidth = 1;
        chartCtx.beginPath();
        for (var i = 0; i < rHistory.length; i++) {
            var x = 30 + i * xs;
            var y = h/2 - rHistory[i].r0 * (h/2 - 10);
            if (i === 0) chartCtx.moveTo(x, y);
            else chartCtx.lineTo(x, y);
        }
        chartCtx.stroke();

        chartCtx.strokeStyle = '#00d4ff';
        chartCtx.lineWidth = 1.5;
        chartCtx.beginPath();
        for (var i = 0; i < rHistory.length; i++) {
            var x = 30 + i * xs;
            var y = h/2 - rHistory[i].rN * (h/2 - 10);
            if (i === 0) chartCtx.moveTo(x, y);
            else chartCtx.lineTo(x, y);
        }
        chartCtx.stroke();
    }

    function drawNN() {
        var w = nnCanvas.width, h = nnCanvas.height;
        var weight = parseFloat(document.getElementById('wSlider').value) / 100;
        var bias = parseFloat(document.getElementById('bSlider').value) / 100;

        nnCtx.fillStyle = 'rgba(10,10,15,0.95)';
        nnCtx.fillRect(0, 0, w, h);

        // è»¸
        nnCtx.strokeStyle = 'rgba(255,255,255,0.2)';
        nnCtx.beginPath();
        nnCtx.moveTo(w/2, 5);
        nnCtx.lineTo(w/2, h - 5);
        nnCtx.moveTo(5, h/2);
        nnCtx.lineTo(w - 5, h/2);
        nnCtx.stroke();

        nnCtx.fillStyle = '#666';
        nnCtx.font = '8px monospace';
        nnCtx.fillText('å…¥åŠ› r', 5, h - 3);
        nnCtx.fillText('å‡ºåŠ›', w - 25, 12);

        // y = x (æ’ç­‰å†™åƒ)
        nnCtx.strokeStyle = 'rgba(255,255,255,0.1)';
        nnCtx.beginPath();
        nnCtx.moveTo(5, h - 5);
        nnCtx.lineTo(w - 5, 5);
        nnCtx.stroke();

        // å†™åƒ f(r) ã‚’ãƒ—ãƒ­ãƒƒãƒˆ
        nnCtx.strokeStyle = '#00d4ff';
        nnCtx.lineWidth = 2;
        nnCtx.beginPath();
        for (var i = 0; i <= 100; i++) {
            var r = (i / 50) - 1;  // -1 to 1
            var fr = nnMap(r, weight, bias);
            var x = (r + 1) / 2 * (w - 10) + 5;
            var y = (1 - (fr + 1) / 2) * (h - 10) + 5;
            if (i === 0) nnCtx.moveTo(x, y);
            else nnCtx.lineTo(x, y);
        }
        nnCtx.stroke();

        // å›ºå®šç‚¹ã‚’æ¢ã™ï¼ˆf(r) = r ã¨ãªã‚‹ç‚¹ï¼‰
        nnCtx.fillStyle = '#f59e0b';
        for (var i = 0; i <= 100; i++) {
            var r = (i / 50) - 1;
            var fr = nnMap(r, weight, bias);
            if (Math.abs(fr - r) < 0.02) {
                var x = (r + 1) / 2 * (w - 10) + 5;
                var y = (1 - (fr + 1) / 2) * (h - 10) + 5;
                nnCtx.beginPath();
                nnCtx.arc(x, y, 4, 0, Math.PI * 2);
                nnCtx.fill();
            }
        }

        nnCtx.fillStyle = '#00d4ff';
        nnCtx.fillText('f(r)=' + currentActivation, 5, 12);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('mazeBtn').onclick = genMaze;
    document.getElementById('startBtn').onclick = startRun;
    document.getElementById('stopBtn').onclick = stopRun;
    document.getElementById('resetBtn').onclick = resetState;

    // åˆæœŸåŒ–
    updateSliders();
    genMaze();
})();
</script>
</body>
</html>

